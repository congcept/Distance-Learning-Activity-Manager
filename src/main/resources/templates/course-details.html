<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Course Details</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
    <div class="container">
        <div th:replace="~{fragments :: header(backLink=@{/courses})}"></div>

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 th:text="${course.title}">Course Name</h2>
            <div th:if="${session.user.role == 'STUDENT'}">
                <form th:action="@{/unenroll}" method="post"
                    onsubmit="return confirm('Are you sure you want to unenroll?');">
                    <input type="hidden" name="courseId" th:value="${courseId}" />
                    <button type="submit" class="btn btn-danger">Unenroll</button>
                </form>
            </div>
        </div>

        <div th:if="${session.user.role == 'INSTRUCTOR'}" style="margin-bottom: 20px;">
            <a th:href="@{/create-activity(courseId=${courseId})}" class="btn btn-primary"
                style="margin-right: 10px;">Add Activity</a>
            <a th:href="@{/create-announcement(courseId=${courseId})}" class="btn btn-primary"
                style="margin-right: 10px;">Make Announcement</a>
            <a th:href="@{/gradebook(courseId=${courseId})}" class="btn btn-primary">View Gradebook</a>
        </div>

        <section class="announcements-section" th:if="${!#lists.isEmpty(announcements)}">
            <h3 style="margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px;">Announcements</h3>
            <div th:each="announcement : ${announcements}" class="announcement-card"
                style="background: #fff9e6; border: 1px solid #ffeeba; padding: 15px; margin-bottom: 15px; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <h4 th:text="${announcement.title}" style="margin: 0 0 10px 0; color: #856404;">Title</h4>
                    <span th:text="${#temporals.format(announcement.postedDate, 'MMM dd, yyyy HH:mm')}"
                        style="font-size: 0.85em; color: #856404;">Date</span>
                </div>
                <p th:text="${announcement.content}" style="margin: 0; color: #856404;">Content</p>

                <div th:if="${session.user.role == 'INSTRUCTOR'}" style="margin-top: 10px; text-align: right;">
                    <form th:action="@{/delete-announcement}" method="post"
                        onsubmit="return confirm('Delete this announcement?');" style="display:inline;">
                        <input type="hidden" name="announcementId" th:value="${announcement.id}">
                        <button type="submit" class="btn btn-danger btn-sm" style="font-size: 0.8em;">Delete</button>
                    </form>
                </div>
            </div>
        </section>

        <h3>Resources</h3>
        <div th:if="${session.user.role == 'INSTRUCTOR'}" style="margin-bottom: 20px;">
            <a th:href="@{/add-resource(courseId=${courseId})}" class="btn btn-primary">Add Resource</a>
        </div>
        <p th:if="${#lists.isEmpty(resources)}">No resources uploaded.</p>
        <ul th:if="${!#lists.isEmpty(resources)}">
            <li th:each="r : ${resources}"
                style="margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 4px; display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div style="margin-bottom: 2px;">
                        <a th:href="@{/resources/download/{id}(id=${r.id})}" th:text="${r.title}"
                            style="font-size: 1.1em; font-weight: bold;">Title</a>
                        <span th:text="' (' + ${#temporals.format(r.uploadDate, 'dd-MM-yyyy HH:mm')} + ')'"
                            style="font-size: 0.8em; color: #94a3b8; margin-left: 5px;"></span>
                    </div>
                    <div th:if="${r.description != null and !r.description.isEmpty()}" th:text="${r.description}"
                        style="color: #64748b; font-size: 0.9em;">Description</div>
                </div>

                <div th:if="${session.user.role == 'INSTRUCTOR'}">
                    <form th:action="@{/resources/delete}" method="post"
                        onsubmit="return confirm('Are you sure you want to delete this resource?');">
                        <input type="hidden" name="resourceId" th:value="${r.id}" />
                        <button type="submit" class="btn btn-danger btn-sm" style="font-size: 0.7em;">Delete</button>
                    </form>
                </div>
            </li>
        </ul>

        <h3>Activities</h3>

        <p th:if="${#lists.isEmpty(activities)}">No activities yet.</p>

        <div th:each="a : ${activities}" class="activity-card clickable-card"
            th:onclick="${session.user.role == 'INSTRUCTOR'} ? 'location.href=\'' + @{/view-submissions(activityId=${a.id}, courseId=${courseId})} + '\'' : 'location.href=\'' + @{/submit-activity(activityId=${a.id}, courseId=${courseId})} + '\''">

            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div class="activity-title"><strong th:text="${a.title}">Title</strong></div>
                    <div class="activity-date">Due: <span
                            th:text="${a.dueDate != null ? #temporals.format(a.dueDate, 'dd-MM-yyyy HH:mm') : 'No Deadline'}">Date</span>
                    </div>
                </div>
                <!-- Edit Button (Top Right) -->
                <div th:if="${session.user.role == 'INSTRUCTOR'}">
                    <a th:href="@{/edit-activity(activityId=${a.id}, courseId=${courseId})}"
                        onclick="event.stopPropagation();" class="btn btn-primary"
                        style="padding: 5px 10px; font-size: 0.8em;">Edit</a>
                </div>
            </div>

            <div th:text="${a.description}">Description</div>
            <div th:if="${a.filePath != null}" style="margin-top: 10px;">
                Attachment: <a th:href="@{${a.filePath}}" th:text="${a.originalFilename}" download
                    onclick="event.stopPropagation();">Download</a>
            </div>

            <div th:if="${session.user.role == 'STUDENT'}">
                <br>
                <span
                    th:if="${!a.singleSubmission or submittedActivityIds == null or !#lists.contains(submittedActivityIds, a.id)}">
                    <span th:if="${a.dueDate != null and a.dueDate.isBefore(now)}" class="error">Past Due</span>
                </span>
                <span
                    th:if="${a.singleSubmission and submittedActivityIds != null and #lists.contains(submittedActivityIds, a.id)}">
                    <em>Submitted (Single Submission Only)</em>
                </span>
            </div>
        </div>
    </div>
</body>

</html>